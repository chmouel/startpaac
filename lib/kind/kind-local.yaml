kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
networking:
  apiServerAddress: "%TARGET_BIND_IP%"
  apiServerPort: 6443
nodes:
  - role: control-plane
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "ingress-ready=true"
    extraMounts:
      - hostPath: /tmp/certs/minica.pem # Root CA from Minica
        containerPath: /etc/ssl/certs/minica.pem
      - hostPath: /tmp/certs/minica.pem
        containerPath: /usr/local/share/ca-certificates/minica.crt
      - hostPath: /tmp/certs/registry.127.0.0.1.nip.io/cert.pem # Server certificate
        containerPath: /etc/ssl/certs/%REGISTRY%.crt
      - hostPath: /tmp/certs/registry.127.0.0.1.nip.io/key.pem # Private key
        containerPath: /etc/ssl/private/%REGISTRY%.key
    extraPortMappings:
      - containerPort: 80
        hostPort: 80
        protocol: TCP
      - containerPort: 443
        hostPort: 443
        protocol: TCP
containerdConfigPatches:
  - |-
    [plugins."io.containerd.grpc.v1.cri".registry.configs."%REGISTRY%".tls]
      ca_file = "/etc/ssl/certs/minica.pem"
